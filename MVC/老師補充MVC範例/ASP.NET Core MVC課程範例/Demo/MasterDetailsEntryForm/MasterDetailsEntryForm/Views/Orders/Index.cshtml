@{
    ViewBag.Title = "Index";
}
@section Styles
{
    <style>
        /*css for table*/
        .container td {
            vertical-align: top;
        }
        .tablecontainer table {
            width: 100%;
            border-collapse: collapse;
            border-top: 1px solid #BFAEAE;
            border-right: 1px solid #BFAEAE;
        }
        .tablecontainer th {
            border-bottom: 2px solid #BFAEAE !important;
        }
        .tablecontainer th, .tablecontainer td {
            text-align: left;
            border-left: 1px solid #BFAEAE;
            padding: 5px;
            border-bottom: 1px solid #BFAEAE;
        }
        .ui-widget {
            font-size: 12px !important;
        }
    </style>
}
<div class="container" style="width:80%">
    <h3>Master Details Entry Form</h3>
    <h4>訂單</h4>
    <div class="mb-3">
        <label class="form-label">選擇客戶:</label>
        <select id="customerIds" asp-items="ViewBag.CustomerId" class="form-control"></select>
    </div>
    <div class="master mb-3">
        <label class="form-label">需要日期:</label>
        <input type="date" id="requiredDate" class="form-control" />
        <span class="text-danger" style="visibility:hidden">需用日期未填寫</span>
    </div>
    <div class="details mb-3">
        <h4>訂單明細:</h4>
        <table class="table table-striped table-hover">
            <thead class="table-success">
                <tr>
                    <th>ProductId</th>
                    <th>UnitPrice</th>
                    <th>Quantity</th>
                    <th>Discount</th>
                    <th>新增</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <input type="text" id="productId" class="form-control" />
                        <span class="text-danger" style="visibility:hidden">商品編號未填寫</span>
                    </td>
                    <td>
                        <input type="text" id="unitPrice" class="form-control" />
                        <span class="text-danger" style="visibility:hidden">商品單價未填寫</span>
                    </td>
                    <td>
                        <input type="text" id="quantity" class="form-control" />
                        <span class="text-danger" style="visibility:hidden">訂購數量未填寫</span>
                    </td>
                    <td>
                        <input type="text" id="discount" class="form-control" />
                        <span class="text-danger" style="visibility:hidden">優惠折扣未填寫</span>
                    </td>
                    <td>
                        <button type="button" id="add" class="btn btn-success">新增明細</button>
                    </td>
                </tr>
            </tbody>

        </table>
        <div id="orderDetailsItems" class="tablecontainer">
        </div>
        <div style="padding:10px 0px; text-align:right">
            <button id="submit" type="button" class="btn btn-primary">新增訂單</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var baseAddress = "https://localhost:7268";
        var orderDetailsItems = [];
        $(document).ready(function () {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                // Set the value of the input field
                document.getElementById('requiredDate').value = tomorrow.toISOString().split('T')[0];

            $('#add').click(function () {
                //Check validation of order details item
                var isValidItem = true;
                if (!($('#productId').val().trim() != '' && !isNaN($('#productId').val().trim()))) {
                    isValidItem = false;
                    $('#productId').next().css('visibility', 'visible');
                }
                else {
                    $('#productId').next().css('visibility', 'hidden');
                }
                if (!($('#unitPrice').val().trim() != '' && !isNaN($('#unitPrice').val().trim()))) {
                    isValidItem = false;
                    $('#unitPrice').next().css('visibility', 'visible');
                }
                else {
                    $('#unitPrice').next().css('visibility', 'hidden');
                }                         
                if (!($('#quantity').val().trim() != '' && !isNaN($('#quantity').val().trim()))) {
                    isValidItem = false;
                    $('#quantity').next().css('visibility', 'visible');
                }
                else {
                    $('#quantity').next().css('visibility', 'hidden');
                }
                if (!($('#discount').val().trim() != '' && !isNaN($('#discount').val().trim()))) {
                    isValidItem = false;
                    $('#discount').next().css('visibility', 'visible');
                }
                else {
                    $('#discount').next().css('visibility', 'hidden');
                }
                if (isValidItem) {
                    orderDetailsItems.push({
                        orderId:0,
                        productId: $('#productId').val().trim(),
                        unitPrice: $('#unitPrice').val().trim(),
                        quantity: parseInt($('#quantity').val().trim()),
                        discount: parseFloat($('#discount').val().trim()),
                    });
                    //Clear fields
                    $('#productId, #unitPrice, #quantity, #discount').val('');
                    $('#productId').focus();
                }
                //populate order details items
                GeneratedItemsTable();
            });
            $('#submit').click(async function () {
                //validation of order
                var isAllValid = true;
                if (orderDetailsItems.length == 0) {
                    $('#orderDetailsItems').html('<span style="color:red;">Please add order items</span>');
                    isAllValid = false;
                }
                if ($('#requiredDate').val().trim() == '') {
                    $('#requiredDate').next().css('visibility', 'visible');
                    isAllValid = false;
                }
                else {
                    $('#requiredDate').next().css('visibility', 'hidden');
                }
                if (isAllValid) {
                    var data = {
                        orderId: -1,
                        customerId: customerIds.value,
                        requiredDate: $('#requiredDate').val().trim(),
                        orderDetails: orderDetailsItems
                    }
                    var response = await fetch(`${baseAddress}/Orders/SaveOrder`, {
                        method:"POST",
                        headers:{
                            "content-type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });
                    var json = await response.json();
                    if (json.status==true){
                        alert("新增成功!");
                    }
                    orderDetailsItems=[];
                    $('#requiredDate').val('');
                    $('#orderDetailsItems').empty();
                }
                else {
                    alert('新增失敗!');
                }
            });
         });
        //function for show added items in table
        function GeneratedItemsTable() {
            if (orderDetailsItems.length > 0) {
                var $table = $('<table class="table table-striped table-hover"/>');
                $table.append('<thead class="table-success"><tr><th>ProductId</th><th>UnitPrice</th><th>Quantity</th><th>Discount</th><th>編輯</th></tr></thead>');
                var $tbody = $('<tbody/>');
                $.each(orderDetailsItems, function (i, val) {
                    var $row = $('<tr/>');
                    $row.append($('<td/>').html(val.productId));
                    $row.append($('<td/>').html(val.unitPrice));
                    $row.append($('<td/>').html(val.quantity));
                    $row.append($('<td/>').html(val.discount));
                    var $remove = $('<button class="btn btn-danger">移除明細</button>');
                    $remove.click(function (e) {
                        e.preventDefault();
                        orderDetailsItems.splice(i, 1);
                        GeneratedItemsTable();
                    });
                    $row.append($('<td/>').html($remove));
                    $tbody.append($row);
                });
                console.log("current", orderDetailsItems);
                $table.append($tbody);
                $('#orderDetailsItems').html($table);
            }
            else {
                $('#orderDetailsItems').html('');
            }
        }
    </script>
}